steps:
# Create GCS Buckets
# Sync workplace to GCS bucket
# - id: initialize_workspace
#   name: 'gcr.io/cloud-builders/gsutil'
#   waitFor: ['-']
#   entrypoint: 'bash'
#   args: 
#   - '-c'
#   - |
#      source values.env
#      gsutil -m rsync -r gs://$${PROJECT_ID}-$${ENV_BUILD_NAME}-tf-backend/workspace/ /workspace
#      echo -e "$${GREEN} Synced /workpace with the gcs bucket gs://$${PROJECT_ID}-$${ENV_BUILD_NAME}-tf-backend/workspace $${NC}"

- id: terraform-google-gcs
  name: gcr.io/$PROJECT_ID/terraform:0.12.16
  entrypoint: 'sh'
  # waitFor:
  # - initialize_workspace 
  args: 
  - '-c'
  - |  
      # set -xe
      source values.env
      function cleanup {
          if [ "$?" == "0" ]
          then 
            echo -e "$${GREEN}Succeeded in deleting the environment $${NC}"
          else 
            echo -e "$${RED}Did not succeed in deleting the enviroment $${NC}"
            exit 0
          fi
      }
      trap cleanup EXIT
      if [ ${_BUILD_ACTION} == 'destroy' ]
      then
        cd env_setup/terraform-google-gcs  
        terraform init \
            -var="project_id=$${PROJECT_ID}" \
            -var="gcs_tf_backend=$${PROJECT_ID}-$${ENV_BUILD_NAME}-tf-backend" \
            -var="gcs_workspace=$${PROJECT_ID}-$${ENV_BUILD_NAME}-workspace" \
            -var="gcs_dataset=$${PROJECT_ID}-$${ENV_BUILD_NAME}-dataset"
        terraform destroy -auto-approve \
            -var="project_id=$${PROJECT_ID}" \
            -var="gcs_tf_backend=$${PROJECT_ID}-$${ENV_BUILD_NAME}-tf-backend" \
            -var="gcs_workspace=$${PROJECT_ID}-$${ENV_BUILD_NAME}-workspace" \
            -var="gcs_dataset=$${PROJECT_ID}-$${ENV_BUILD_NAME}-dataset" 
      fi 
